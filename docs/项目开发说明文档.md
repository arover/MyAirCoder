# Roo Code 项目开发说明文档

> 面向中级软件工程师的完整开发指南

## 目录

1. [项目概述](#项目概述)
2. [技术架构](#技术架构)
3. [核心技术栈](#核心技术栈)
4. [项目结构](#项目结构)
5. [核心功能模块](#核心功能模块)
6. [开发环境搭建](#开发环境搭建)
7. [开发工作流程](#开发工作流程)
8. [核心概念详解](#核心概念详解)
9. [测试指南](#测试指南)
10. [调试技巧](#调试技巧)
11. [常见问题](#常见问题)
12. [贡献指南](#贡献指南)

---

## 项目概述

### 什么是 Roo Code？

Roo Code 是一个强大的 VSCode 扩展，提供 AI 驱动的开发助手功能。它原名 Cline，是一个自主编码代理，可以直接在 IDE 中帮助开发者完成各种编程任务。

### 核心特性

- **多模式支持**：Code（编码）、Architect（架构设计）、Ask（问答）、Debug（调试）、Custom（自定义模式）
- **AI 集成**：支持多个 AI 提供商（Anthropic Claude、OpenAI、OpenRouter 等 30+ 提供商）
- **工具执行**：文件操作、命令执行、浏览器自动化、Git 集成等
- **MCP 协议**：支持 Model Context Protocol，可扩展 AI 能力
- **代码索引**：使用向量数据库进行代码语义搜索
- **云服务集成**：Roo Code Cloud 支持远程任务控制
- **国际化**：支持 17+ 种语言

### 项目定位

- **目标用户**：使用 VSCode 的开发者
- **应用场景**：代码生成、重构、调试、文档编写、问题解答、自动化任务
- **技术定位**：VSCode 扩展 + AI 驱动 + 工具执行引擎

---

## 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        VSCode Extension                      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Extension Host (Node.js)                  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  ClineProvider (核心提供者)                      │  │  │
│  │  │  - 管理任务栈                                    │  │  │
│  │  │  - 状态管理 (ContextProxy)                      │  │  │
│  │  │  - 与 Webview 通信                              │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Task (任务执行引擎)                            │  │  │
│  │  │  - 生命周期管理                                 │  │  │
│  │  │  - API 流式处理                                 │  │  │
│  │  │  - 工具调用执行                                 │  │  │
│  │  │  - 检查点系统                                   │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Services (服务层)                              │  │  │
│  │  │  - McpHub: MCP 服务器管理                       │  │  │
│  │  │  - CloudService: 云服务集成                     │  │  │
│  │  │  - TelemetryService: 遥测服务                   │  │  │
│  │  │  - CodeIndexManager: 代码索引                   │  │  │
│  │  │  - BrowserSession: 浏览器自动化                 │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  API Handlers (多提供商支持)                    │  │  │
│  │  │  - AnthropicHandler                             │  │  │
│  │  │  - OpenAiHandler                                │  │  │
│  │  │  - 30+ 其他提供商                               │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Webview UI (React)                        │  │
│  │  - 用户界面                                            │  │
│  │  - 消息显示                                            │  │
│  │  - 设置管理                                            │  │
│  │  - 任务历史                                            │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 架构特点

1. **分层架构**
   - Extension Host：后端逻辑（Node.js 环境）
   - Webview UI：前端界面（浏览器环境）
   - 通过消息传递机制通信

2. **事件驱动**
   - 基于 EventEmitter 的事件系统
   - 异步流式 API 处理
   - 工具执行的回调机制

3. **插件化设计**
   - 多 AI 提供商支持
   - MCP 协议扩展
   - 自定义模式系统

4. **状态管理**
   - ContextProxy：全局状态管理
   - 持久化存储（VSCode Memento）
   - 任务历史和检查点

---

## 核心技术栈

### 后端技术（Extension Host）

| 技术 | 版本 | 用途 |
|------|------|------|
| **TypeScript** | 5.x | 主要开发语言 |
| **Node.js** | 18+ | 运行时环境 |
| **VSCode Extension API** | 1.95.0+ | 扩展开发框架 |
| **Anthropic SDK** | 最新 | Claude AI 集成 |
| **OpenAI SDK** | 最新 | OpenAI 集成 |
| **Puppeteer** | 最新 | 浏览器自动化 |
| **Qdrant Client** | 最新 | 向量数据库客户端 |
| **MCP SDK** | 最新 | Model Context Protocol |
| **Zod** | 最新 | 运行时类型验证 |
| **Chokidar** | 最新 | 文件监听 |
| **i18next** | 最新 | 国际化 |

### 前端技术（Webview UI）

| 技术 | 版本 | 用途 |
|------|------|------|
| **React** | 18.x | UI 框架 |
| **TypeScript** | 5.x | 类型安全 |
| **Vite** | 5.x | 构建工具 |
| **Tailwind CSS** | 4.x | 样式框架 |
| **Radix UI** | 最新 | 无障碍组件库 |
| **Zustand** | 最新 | 状态管理 |
| **React Markdown** | 最新 | Markdown 渲染 |
| **Mermaid** | 最新 | 图表渲染 |

### 开发工具

| 工具 | 用途 |
|------|------|
| **pnpm** | 包管理器 |
| **Turborepo** | Monorepo 构建工具 |
| **Vitest** | 测试框架 |
| **ESLint** | 代码检查 |
| **Prettier** | 代码格式化 |
| **esbuild** | 扩展打包 |
| **Changesets** | 版本管理 |

---

## 项目结构

### Monorepo 结构

```
vscode-ai-agent/
├── src/                          # 扩展主代码
│   ├── extension.ts              # 扩展入口
│   ├── activate/                 # 激活逻辑
│   ├── api/                      # API 处理层
│   │   ├── index.ts              # API Handler 工厂
│   │   ├── providers/            # 各 AI 提供商实现
│   │   └── transform/            # 消息格式转换
│   ├── core/                     # 核心功能
│   │   ├── task/                 # Task 类
│   │   ├── webview/              # ClineProvider
│   │   └── prompts/              # 提示词管理
│   ├── services/                 # 服务层
│   │   ├── mcp/                  # MCP 集成
│   │   ├── code-index/           # 代码索引
│   │   ├── browser/              # 浏览器自动化
│   │   ├── checkpoints/          # 检查点系统
│   │   └── ...                   # 其他服务
│   ├── integrations/             # 外部集成
│   ├── shared/                   # 共享代码
│   ├── i18n/                     # 国际化
│   └── __tests__/                # 测试文件
├── webview-ui/                   # React UI
│   ├── src/
│   │   ├── components/           # React 组件
│   │   ├── context/              # Context 提供者
│   │   ├── utils/                # 工具函数
│   │   └── App.tsx               # 主应用
│   ├── index.html                # 主 Webview
│   └── browser-panel.html        # 浏览器面板
├── packages/                     # 共享包
│   ├── types/                    # 类型定义
│   ├── telemetry/                # 遥测服务
│   └── build/                    # 构建工具
├── apps/                         # 应用变体
│   └── vscode-nightly/           # Nightly 版本
├── .roo/                         # Roo 配置
│   ├── modes/                    # 自定义模式
│   ├── rules/                    # 项目规则
│   └── skills/                   # 技能定义
├── turbo.json                    # Turborepo 配置
├── pnpm-workspace.yaml           # pnpm 工作区
└── package.json                  # 根 package.json
```

### 关键目录说明

#### `src/` - 扩展核心代码

- **`extension.ts`**: 扩展的入口点，包含 `activate()` 和 `deactivate()` 函数
- **`activate/`**: 扩展激活时的初始化逻辑
  - `index.ts`: 主激活流程
  - `registerCommands.ts`: 注册 VSCode 命令
  - `handleTask.ts`: 任务处理逻辑
- **`api/`**: AI API 处理层
  - `index.ts`: `buildApiHandler()` 工厂函数
  - `providers/`: 各个 AI 提供商的具体实现
  - `transform/`: 消息格式转换和流处理
- **`core/`**: 核心业务逻辑
  - `task/Task.ts`: 任务生命周期管理（3000+ 行核心类）
  - `webview/ClineProvider.ts`: 主提供者类（2000+ 行）
  - `prompts/`: 系统提示词和工具定义
- **`services/`**: 各种服务模块
  - `mcp/McpHub.ts`: MCP 服务器管理（2000+ 行）
  - `code-index/`: 代码索引服务
  - `browser/`: Puppeteer 浏览器自动化
  - `checkpoints/`: Git 检查点系统

#### `webview-ui/` - React 前端

- **`src/components/`**: React 组件
  - `chat/`: 聊天界面组件
  - `settings/`: 设置界面
  - `history/`: 任务历史
- **`src/context/`**: React Context
  - `ExtensionStateContext.tsx`: 扩展状态管理
- **`src/utils/`**: 前端工具函数

#### `packages/` - 共享包

- **`types/`**: TypeScript 类型定义，被多个包共享
- **`telemetry/`**: PostHog 遥测集成
- **`build/`**: 构建脚本和工具

---

## 核心功能模块

### 1. Task 类 - 任务执行引擎

**位置**: `src/core/task/Task.ts`

**职责**: 管理 AI 辅助任务的完整生命周期

**核心功能**:

```typescript
export class Task extends EventEmitter<TaskEvents> implements TaskLike {
    // 任务标识
    readonly taskId: string
    readonly instanceId: string
    readonly metadata: TaskMetadata
    
    // API 配置
    apiConfiguration: ProviderSettings
    api: ApiHandler
    
    // 消息历史
    clineMessages: ClineMessage[]
    apiConversationHistory: ApiMessage[]
    
    // 生命周期方法
    private async startTask(task?: string, images?: string[]): Promise<void>
    private async resumeTaskFromHistory(): Promise<void>
    public async abortTask(isAbandoned = false): Promise<void>
    
    // 核心循环
    public async recursivelyMakeClineRequests(...): Promise<boolean>
    
    // 工具执行
    private async executeTool(toolName: string, toolInput: any): Promise<ToolResponse>
    
    // 上下文管理
    public async condenseContext(): Promise<void>
}
```

**关键特性**:

1. **流式 API 处理**: 处理 AI 响应的流式传输
2. **工具调用**: 执行文件操作、命令、浏览器自动化等
3. **检查点系统**: 保存和恢复任务状态
4. **错误重试**: 自动重试失败的 API 调用
5. **令牌管理**: 跟踪和限制令牌使用
6. **任务委托**: 支持子任务和任务链

### 2. ClineProvider - 核心提供者

**位置**: `src/core/webview/ClineProvider.ts`

**职责**: 管理扩展的全局状态和 Webview 通信

**核心功能**:

```typescript
export class ClineProvider implements vscode.WebviewViewProvider {
    // 任务管理
    private taskStack: Task[] = []
    
    // 状态管理
    private contextProxy: ContextProxy
    
    // 服务集成
    private mcpHub: McpHub
    private cloudService: CloudService
    
    // Webview 通信
    async postMessageToWebview(message: ExtensionMessage): Promise<void>
    private async handleWebviewMessage(message: WebviewMessage): Promise<void>
    
    // 任务操作
    async addClineToStack(task?: string, images?: string[]): Promise<void>
    async removeClineFromStack(): Promise<void>
}
```

**关键特性**:

1. **任务栈管理**: 支持多任务并发
2. **状态持久化**: 使用 ContextProxy 管理全局状态
3. **消息路由**: 处理 Webview 和 Extension Host 之间的通信
4. **模式切换**: 管理不同工作模式
5. **配置管理**: API 配置、Provider Profile 等

### 3. API Handler - 多提供商支持

**位置**: `src/api/`

**架构**:

```typescript
// 工厂函数
export function buildApiHandler(configuration: ProviderSettings): ApiHandler {
    switch (apiProvider) {
        case "anthropic": return new AnthropicHandler(options)
        case "openai": return new OpenAiHandler(options)
        case "openrouter": return new OpenRouterHandler(options)
        // ... 30+ 提供商
    }
}

// 统一接口
export interface ApiHandler {
    createMessage(
        systemPrompt: string,
        messages: Anthropic.Messages.MessageParam[],
        metadata?: ApiHandlerCreateMessageMetadata
    ): ApiStream
    
    getModel(): { id: string; info: ModelInfo }
    countTokens(content: Array<Anthropic.Messages.ContentBlockParam>): Promise<number>
}
```

**支持的提供商**:

- Anthropic (Claude)
- OpenAI (GPT-4, o1, o3)
- OpenRouter
- AWS Bedrock
- Google Gemini
- Vertex AI
- DeepSeek
- Mistral
- Groq
- 等 30+ 提供商

**关键特性**:

1. **统一接口**: 所有提供商实现相同的 `ApiHandler` 接口
2. **流式处理**: 支持流式 API 响应
3. **格式转换**: 自动转换不同提供商的消息格式
4. **缓存支持**: Prompt Caching（Anthropic、OpenRouter）
5. **工具调用**: 原生工具调用协议支持

### 4. McpHub - MCP 服务器管理

**位置**: `src/services/mcp/McpHub.ts`

**职责**: 管理 Model Context Protocol 服务器连接

**核心功能**:

```typescript
export class McpHub {
    connections: McpConnection[] = []
    
    // 服务器管理
    private async connectToServer(name: string, config: ServerConfig): Promise<void>
    async deleteConnection(name: string, source?: "global" | "project"): Promise<void>
    async restartConnection(serverName: string): Promise<void>
    
    // 工具和资源
    async callTool(serverName: string, toolName: string, args?: Record<string, unknown>): Promise<McpToolCallResponse>
    async readResource(serverName: string, uri: string): Promise<McpResourceResponse>
    
    // 配置管理
    async toggleServerDisabled(serverName: string, disabled: boolean): Promise<void>
    async toggleToolAlwaysAllow(serverName: string, toolName: string, shouldAllow: boolean): Promise<void>
}
```

**支持的传输类型**:

1. **stdio**: 本地进程通信
2. **SSE**: Server-Sent Events
3. **streamable-http**: HTTP 流式传输

**关键特性**:

1. **自动重连**: 连接断开时自动重试
2. **文件监听**: 监听配置文件变化并自动重启
3. **工具管理**: 管理工具的启用/禁用和自动批准
4. **双层配置**: 支持全局和项目级配置

### 5. 代码索引服务

**位置**: `src/services/code-index/`

**架构**:

```typescript
// 主管理器
export class CodeIndexManager {
    async indexWorkspace(): Promise<void>
    async search(query: string, limit?: number): Promise<SearchResult[]>
    async clearIndex(): Promise<void>
}

// 向量存储
export class QdrantClient {
    async upsertPoints(points: Point[]): Promise<void>
    async search(vector: number[], limit: number): Promise<SearchResult[]>
}

// 嵌入器
export interface Embedder {
    embed(texts: string[]): Promise<number[][]>
}
```

**支持的嵌入提供商**:

- OpenAI
- Gemini
- Mistral
- Ollama
- Bedrock
- OpenRouter
- Vercel AI Gateway

**关键特性**:

1. **语义搜索**: 基于向量相似度的代码搜索
2. **增量索引**: 监听文件变化并增量更新
3. **缓存机制**: 缓存嵌入结果以提高性能
4. **多语言支持**: 使用 Tree-sitter 解析多种编程语言

### 6. 浏览器自动化

**位置**: `src/services/browser/`

**核心类**:

```typescript
export class BrowserSession {
    private browser?: Browser
    private page?: Page
    
    async launch(): Promise<void>
    async navigate(url: string): Promise<void>
    async click(selector: string): Promise<void>
    async type(selector: string, text: string): Promise<void>
    async screenshot(): Promise<string>
    async close(): Promise<void>
}
```

**关键特性**:

1. **Puppeteer 集成**: 使用 Puppeteer 控制浏览器
2. **截图功能**: 捕获页面截图并发送给 AI
3. **交互操作**: 点击、输入、导航等
4. **会话管理**: 管理浏览器实例的生命周期

### 7. 检查点系统

**位置**: `src/services/checkpoints/`

**实现方式**:

```typescript
export interface CheckpointService {
    save(taskId: string, message: string): Promise<void>
    restore(taskId: string, checkpointId: string): Promise<void>
    list(taskId: string): Promise<Checkpoint[]>
    delete(taskId: string, checkpointId: string): Promise<void>
}

// Shadow 实现（使用 Git worktree）
export class ShadowCheckpointService implements CheckpointService {
    // 使用 Git worktree 创建隔离的工作副本
}

// Repo-per-task 实现
export class RepoPerTaskCheckpointService implements CheckpointService {
    // 为每个任务创建独立的 Git 仓库
}
```

**关键特性**:

1. **Git 集成**: 使用 Git 作为底层存储
2. **隔离性**: 每个检查点互不干扰
3. **快速恢复**: 快速回滚到任何检查点
4. **自动清理**: 任务完成后自动清理临时文件

---

## 开发环境搭建

### 前置要求

- **Node.js**: 18.x 或更高版本
- **pnpm**: 8.x 或更高版本
- **VSCode**: 1.95.0 或更高版本
- **Git**: 2.x 或更高版本

### 安装步骤

#### 1. 克隆仓库

```bash
git clone https://github.com/RooCodeInc/Roo-Code.git
cd Roo-Code
```

#### 2. 安装依赖

```bash
pnpm install
```

这将安装所有工作区的依赖，包括：
- 扩展依赖（`src/`）
- Webview UI 依赖（`webview-ui/`）
- 共享包依赖（`packages/`）

#### 3. 构建项目

```bash
# 构建所有包
pnpm build

# 或者只构建特定包
pnpm --filter @roo-code/types build
pnpm --filter webview-ui build
```

### 开发模式

#### 方式 1: F5 调试（推荐）

1. 在 VSCode 中打开项目
2. 按 `F5` 或选择 **Run → Start Debugging**
3. 这将打开一个新的 VSCode 窗口，扩展已加载

**特点**:
- Webview 更改立即生效（HMR）
- 扩展代码更改自动热重载
- 支持断点调试

#### 方式 2: 自动 VSIX 安装

```bash
# 交互式安装
pnpm install:vsix

# 跳过确认，使用默认编辑器
pnpm install:vsix -y

# 指定编辑器
pnpm install:vsix --editor=cursor
pnpm install:vsix --editor=code-insiders
```

这将：
1. 卸载现有版本
2. 构建最新的 VSIX 包
3. 安装新构建的 VSIX
4. 提示重启 VSCode

#### 方式 3: 手动 VSIX 安装

```bash
# 1. 构建 VSIX
pnpm vsix

# 2. 安装（VSIX 文件在 bin/ 目录）
code --install-extension bin/roo-cline-<version>.vsix
```

### 开发服务器

Webview UI 使用 Vite 开发服务器：

```bash
# 启动 Webview 开发服务器
cd webview-ui
pnpm dev
```

服务器会在 `http://localhost:5173` 启动，端口号会写入 `.vite-port` 文件供扩展读取。

---

## 开发工作流程

### 日常开发流程

#### 1. 创建功能分支

```bash
git checkout -b feature/your-feature-name
```

#### 2. 开发和测试

```bash
# 启动开发模式（F5）
# 或者运行测试
pnpm test

# 运行特定测试
cd src
npx vitest run path/to/test-file.spec.ts
```

#### 3. 代码检查

```bash
# Lint 检查
pnpm lint

# 类型检查
pnpm typecheck

# 格式化代码
pnpm format
```

#### 4. 提交更改

使用 Changesets 管理版本：

```bash
# 添加 changeset
pnpm changeset

# 提交代码
git add .
git commit -m "feat: your feature description"
```

#### 5. 创建 Pull Request

推送分支并在 GitHub 上创建 PR。

### 测试工作流

#### 单元测试

```bash
# 运行所有测试
pnpm test

# 监听模式
pnpm test:watch

# 覆盖率报告
pnpm test:coverage
```

#### 测试文件位置

- 扩展测试: `src/__tests__/`
- Webview 测试: `webview-ui/src/__tests__/`
- 服务测试: `src/services/*/tests__/`

#### 测试注意事项

根据 `.roo/rules/rules.md`:

1. **测试必须从正确的目录运行**:
   ```bash
   # 后端测试
   cd src && npx vitest run tests/user.test.ts
   
   # UI 测试
   cd webview-ui && npx vitest run src/path/to/test-file
   ```

2. **不要从项目根目录运行测试**，会导致 "vitest: command not found" 错误

3. **Vitest 全局函数**（`vi`, `describe`, `test`, `it`）已在 `tsconfig.json` 中定义，无需导入

### 构建和打包

#### 开发构建

```bash
# 构建所有包
pnpm build

# 构建特定包
pnpm --filter @roo-code/types build
pnpm --filter webview-ui build
```

#### 生产构建

```bash
# 构建 VSIX 包
pnpm vsix

# 输出: bin/roo-cline-<version>.vsix
```

#### Turborepo 缓存

项目使用 Turborepo 进行构建优化：

```bash
# 清除缓存
pnpm turbo clean

# 查看缓存统计
pnpm turbo run build --summarize
```

### 版本管理

使用 Changesets 进行版本管理：

```bash
# 1. 添加 changeset
pnpm changeset
# 选择变更类型: patch/minor/major
# 输入变更描述

# 2. 版本升级
pnpm changeset version

# 3. 发布（维护者）
pnpm changeset publish
```

### 调试配置

#### VSCode 调试配置

`.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Run Extension",
      "type": "extensionHost",
      "request": "launch",
      "args": [
        "--extensionDevelopmentPath=${workspaceFolder}"
      ],
      "outFiles": [
        "${workspaceFolder}/src/out/**/*.js"
      ],
      "preLaunchTask": "npm: watch"
    }
  ]
}
```

#### 调试技巧

1. **Extension Host 调试**:
   - 在 TypeScript 代码中设置断点
   - 按 F5 启动调试
   - 断点会在新窗口中触发

2. **Webview 调试**:
   - 在 Webview 中右键 → "Inspect Element"
   - 使用 Chrome DevTools 调试 React 代码

3. **日志输出**:
   ```typescript
   // Extension Host
   console.log("Debug info")
   outputChannel.appendLine("Info")
   
   // Webview
   console.log("Webview debug")
   ```

---

## 核心概念详解

### 1. Extension Host vs Webview

#### Extension Host（扩展宿主）

- **环境**: Node.js
- **能力**: 完整的 Node.js API 和 VSCode API
- **用途**: 业务逻辑、文件操作、API 调用
- **代码位置**: `src/`

#### Webview（Web 视图）

- **环境**: 浏览器（类似 iframe）
- **能力**: 受限的浏览器 API，无法直接访问文件系统
- **用途**: 用户界面、消息显示
- **代码位置**: `webview-ui/`

#### 通信机制

```typescript
// Extension Host → Webview
await provider.postMessageToWebview({
    type: "state",
    state: { ... }
})

// Webview → Extension Host
vscode.postMessage({
    type: "newTask",
    text: "Create a new feature"
})
```

### 2. 任务生命周期

```
┌─────────────┐
│   创建任务   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  初始化 API  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  发送请求    │◄─────┐
└──────┬──────┘      │
       │             │
       ▼             │
┌─────────────┐      │
│  接收响应    │      │
└──────┬──────┘      │
       │             │
       ▼             │
┌─────────────┐      │
│  执行工具    │      │
└──────┬──────┘      │
       │             │
       ▼             │
┌─────────────┐      │
│  用户确认    │      │
└──────┬──────┘      │
       │             │
       ├─────────────┘
       │
       ▼
┌─────────────┐
│  任务完成    │
└─────────────┘
```

### 3. 消息流转

```
User Input (Webview)
    │
    ▼
WebviewMessage
    │
    ▼
ClineProvider.handleWebviewMessage()
    │
    ▼
Task.startTask() / Task.resumeTaskFromHistory()
    │
    ▼
Task.recursivelyMakeClineRequests()
    │
    ├─► ApiHandler.createMessage()
    │       │
    │       ▼
    │   AI Provider (Anthropic/OpenAI/...)
    │       │
    │       ▼
    │   Streaming Response
    │
    ├─► Tool Execution
    │       │
    │       ▼
    │   File Operations / Commands / Browser / MCP
    │
    └─► User Approval (if needed)
            │
            ▼
        Continue Loop or Complete
```

### 4. 状态管理

#### ContextProxy

全局状态管理器，使用 VSCode Memento 持久化：

```typescript
export class ContextProxy {
    private state: ExtensionState
    private memento: vscode.Memento
    
    async getState(): Promise<ExtensionState>
    async updateState(updates: Partial<ExtensionState>): Promise<void>
}
```

#### 状态结构

```typescript
interface ExtensionState {
    // API 配置
    apiConfiguration?: ProviderSettings
    
    // 任务历史
    taskHistory: HistoryItem[]
    
    // MCP 配置
    mcpEnabled?: boolean
    
    // 用户设置
    alwaysAllowReadOnly?: boolean
    alwaysAllowWrite?: boolean
    
    // 其他配置...
}
```

### 5. 工具系统

#### 工具定义

```typescript
interface Tool {
    name: string
    description: string
    input_schema: {
        type: "object"
        properties: Record<string, any>
        required?: string[]
    }
}
```

#### 内置工具

1. **文件操作**:
   - `read_file`: 读取文件
   - `write_to_file`: 写入文件
   - `list_files`: 列出文件
   - `search_files`: 搜索文件

2. **命令执行**:
   - `execute_command`: 执行 CLI 命令

3. **浏览器**:
   - `browser_action`: 浏览器自动化

4. **代码搜索**:
   - `codebase_search`: 语义代码搜索

5. **MCP 工具**:
   - 动态加载的 MCP 服务器工具

#### 工具执行流程

```typescript
// 1. AI 返回工具调用
{
    type: "tool_use",
    name: "write_to_file",
    input: {
        path: "src/app.ts",
        content: "..."
    }
}

// 2. Task 执行工具
const result = await this.executeTool(toolName, toolInput)

// 3. 返回结果给 AI
{
    type: "tool_result",
    tool_use_id: "...",
    content: "File written successfully"
}
```

### 6. 模式系统

#### 内置模式

1. **Code Mode**: 日常编码、编辑、文件操作
2. **Architect Mode**: 系统设计、规范、迁移计划
3. **Ask Mode**: 快速问答、解释、文档
4. **Debug Mode**: 问题追踪、日志、根因分析
5. **Custom Modes**: 自定义工作流

#### 模式配置

位置: `.roo/modes/`

```markdown
---
name: Custom Mode
slug: custom-mode
version: 1.0.0
---

# System Prompt

You are a specialized assistant for...

## Rules

- Rule 1
- Rule 2

## Tools

- tool1
- tool2
```

#### 模式切换

```typescript
// 切换模式
await provider.switchMode("architect")

// 模式影响：
// 1. 系统提示词
// 2. 可用工具
// 3. 文件编辑权限
```

---

## 测试指南

### 测试框架

项目使用 **Vitest** 作为测试框架。

### 测试类型

#### 1. 单元测试

测试单个函数或类：

```typescript
// src/services/code-index/__tests__/cache-manager.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { CacheManager } from '../cache-manager'

describe('CacheManager', () => {
    let cacheManager: CacheManager
    
    beforeEach(() => {
        cacheManager = new CacheManager()
    })
    
    it('should cache embeddings', async () => {
        const text = "test code"
        const embedding = [0.1, 0.2, 0.3]
        
        await cacheManager.set(text, embedding)
        const cached = await cacheManager.get(text)
        
        expect(cached).toEqual(embedding)
    })
})
```

#### 2. 集成测试

测试多个模块的交互：

```typescript
// src/__tests__/delegation-events.spec.ts
describe('Task Delegation', () => {
    it('should handle delegation events correctly', async () => {
        const parentTask = new Task(...)
        const childTask = await parentTask.delegate(...)
        
        // 验证事件传播
        expect(childTask.metadata.parentTaskId).toBe(parentTask.taskId)
    })
})
```

#### 3. API 测试

测试 API 提供商：

```typescript
// src/api/providers/__tests__/anthropic.spec.ts
describe('AnthropicHandler', () => {
    it('should handle streaming responses', async () => {
        const handler = new AnthropicHandler(config)
        const stream = handler.createMessage(systemPrompt, messages)
        
        for await (const chunk of stream) {
            // 验证流式响应
        }
    })
})
```

### 运行测试

```bash
# 所有测试
pnpm test

# 特定文件
cd src
npx vitest run __tests__/delegation-events.spec.ts

# 监听模式
pnpm test:watch

# 覆盖率
pnpm test:coverage
```

### Mock 和 Stub

```typescript
import { vi } from 'vitest'

// Mock 函数
const mockFn = vi.fn()
mockFn.mockReturnValue('result')

// Mock 模块
vi.mock('vscode', () => ({
    window: {
        showInformationMessage: vi.fn()
    }
}))

// Spy
const spy = vi.spyOn(object, 'method')
```

### 测试最佳实践

1. **测试命名**: 使用描述性名称
   ```typescript
   it('should return error when file does not exist', ...)
   ```

2. **AAA 模式**: Arrange, Act, Assert
   ```typescript
   // Arrange
   const input = "test"
   
   // Act
   const result = processInput(input)
   
   // Assert
   expect(result).toBe("expected")
   ```

3. **隔离测试**: 每个测试独立，不依赖其他测试

4. **清理资源**: 使用 `afterEach` 清理
   ```typescript
   afterEach(() => {
       vi.clearAllMocks()
   })
   ```

---

## 调试技巧

### 1. Extension Host 调试

#### 设置断点

1. 在 TypeScript 文件中点击行号左侧设置断点
2. 按 F5 启动调试
3. 触发相关功能，断点会暂停执行

#### 调试控制台

```typescript
// 输出到调试控制台
console.log("Debug info:", variable)

// 输出到 Output Channel
outputChannel.appendLine(`Info: ${message}`)
```

#### 查看变量

- 鼠标悬停在变量上查看值
- 使用 Debug Console 执行表达式
- 查看 Call Stack 追踪调用链

### 2. Webview 调试

#### 打开 DevTools

1. 在 Webview 中右键
2. 选择 "Inspect Element"
3. 使用 Chrome DevTools

#### React DevTools

安装 React DevTools 扩展查看组件树和状态。

#### 网络请求

在 Network 标签查看 Webview 和 Extension Host 之间的消息。

### 3. 日志调试

#### 结构化日志

```typescript
// 使用 JSON 格式
console.log(JSON.stringify({
    event: "tool_execution",
    tool: toolName,
    input: toolInput,
    timestamp: Date.now()
}, null, 2))
```

#### 条件日志

```typescript
const DEBUG = process.env.DEBUG === "true"

if (DEBUG) {
    console.log("Debug info")
}
```

### 4. 性能分析

#### 时间测量

```typescript
console.time("operation")
// ... 操作
console.timeEnd("operation")
```

#### 内存使用

```typescript
const used = process.memoryUsage()
console.log(`Memory: ${Math.round(used.heapUsed / 1024 / 1024)} MB`)
```

### 5. 常见问题调试

#### 问题: Webview 不显示

**检查**:
1. Webview 是否正确注册
2. HTML 文件路径是否正确
3. CSP 配置是否正确

#### 问题: 消息未传递

**检查**:
1. 消息类型是否匹配
2. 消息处理器是否注册
3. 使用 console.log 追踪消息流

#### 问题: API 调用失败

**检查**:
1. API Key 是否正确
2. 网络连接是否正常
3. 查看错误日志
4. 检查 API 配置

---

## 常见问题

### 开发环境问题

#### Q: pnpm install 失败

**A**: 
1. 确保 Node.js 版本 >= 18
2. 清除缓存: `pnpm store prune`
3. 删除 `node_modules` 和 `pnpm-lock.yaml`，重新安装

#### Q: F5 调试无法启动

**A**:
1. 确保已运行 `pnpm install`
2. 检查 `.vscode/launch.json` 配置
3. 查看 Output → Extension Host 日志

#### Q: Webview 显示空白

**A**:
1. 检查 `webview-ui/build` 目录是否存在
2. 运行 `pnpm --filter webview-ui build`
3. 检查 CSP 配置

### 测试问题

#### Q: vitest: command not found

**A**: 
必须从正确的目录运行测试：
```bash
# 错误
npx vitest run src/tests/user.test.ts

# 正确
cd src && npx vitest run tests/user.test.ts
```

#### Q: 测试超时

**A**:
增加超时时间：
```typescript
it('long running test', async () => {
    // ...
}, 10000) // 10 秒超时
```

### API 问题

#### Q: API 调用失败

**A**:
1. 检查 API Key 是否正确
2. 检查网络连接
3. 查看 Output Channel 日志
4. 验证模型 ID 是否正确

#### Q: 流式响应中断

**A**:
1. 检查网络稳定性
2. 增加超时时间
3. 查看 API 提供商状态

### MCP 问题

#### Q: MCP 服务器连接失败

**A**:
1. 检查服务器配置是否正确
2. 验证命令路径是否存在
3. 查看服务器日志（stderr）
4. 尝试手动运行服务器命令

#### Q: MCP 工具不可用

**A**:
1. 确保服务器已连接
2. 检查工具是否被禁用
3. 刷新 MCP 连接

### 构建问题

#### Q: VSIX 构建失败

**A**:
1. 运行 `pnpm build` 确保所有包已构建
2. 检查 `src/package.json` 版本号
3. 清除 Turborepo 缓存: `pnpm turbo clean`

#### Q: 类型错误

**A**:
1. 运行 `pnpm typecheck` 查看详细错误
2. 确保 `@roo-code/types` 已构建
3. 重启 TypeScript 服务器

---

## 贡献指南

### 贡献流程

1. **Fork 仓库**
2. **创建功能分支**: `git checkout -b feature/amazing-feature`
3. **提交更改**: `git commit -m 'feat: add amazing feature'`
4. **推送分支**: `git push origin feature/amazing-feature`
5. **创建 Pull Request**

### 代码规范

#### TypeScript 风格

- 使用 TypeScript strict 模式
- 优先使用接口而非类型别名（对于对象）
- 使用明确的类型注解
- 避免 `any` 类型

#### 命名约定

- **文件**: kebab-case (`user-service.ts`)
- **类**: PascalCase (`UserService`)
- **函数/变量**: camelCase (`getUserData`)
- **常量**: UPPER_SNAKE_CASE (`MAX_RETRIES`)
- **接口**: PascalCase, 不使用 `I` 前缀 (`User`, 不是 `IUser`)

#### 注释

```typescript
/**
 * 获取用户数据
 * @param userId 用户 ID
 * @returns 用户对象
 * @throws {Error} 当用户不存在时
 */
async function getUserData(userId: string): Promise<User> {
    // 实现
}
```

### Commit 规范

使用 Conventional Commits:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型**:
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具更改

**示例**:
```
feat(api): add support for GPT-4 Turbo

- Add GPT-4 Turbo model configuration
- Update model info with correct pricing
- Add tests for new model

Closes #123
```

### Pull Request 指南

#### PR 标题

使用 Conventional Commits 格式。

#### PR 描述

包含：
1. **变更说明**: 做了什么
2. **动机**: 为什么做
3. **测试**: 如何测试
4. **截图**: 如果有 UI 变更
5. **相关 Issue**: `Closes #123`

#### PR 检查清单

- [ ] 代码通过 lint 检查
- [ ] 添加了测试
- [ ] 测试通过
- [ ] 更新了文档
- [ ] 添加了 changeset（如果需要）

### 代码审查

#### 审查者关注点

1. **功能正确性**: 代码是否实现了预期功能
2. **代码质量**: 是否遵循最佳实践
3. **测试覆盖**: 是否有足够的测试
4. **性能**: 是否有性能问题
5. **安全性**: 是否有安全隐患

#### 提交者响应

- 及时响应审查意见
- 解释设计决策
- 进行必要的修改
- 标记已解决的评论

### 发布流程

1. **创建 Changeset**:
   ```bash
   pnpm changeset
   ```

2. **版本升级**（维护者）:
   ```bash
   pnpm changeset version
   ```

3. **发布**（维护者）:
   ```bash
   pnpm changeset publish
   ```

---

## 附录

### 有用的资源

#### 官方文档

- [Roo Code 文档](https://docs.roocode.com)
- [VSCode Extension API](https://code.visualstudio.com/api)
- [TypeScript 文档](https://www.typescriptlang.org/docs/)
- [React 文档](https://react.dev/)

#### 社区

- [Discord](https://discord.gg/roocode)
- [Reddit](https://www.reddit.com/r/RooCode/)
- [GitHub Issues](https://github.com/RooCodeInc/Roo-Code/issues)
- [YouTube](https://youtube.com/@roocodeyt)

#### 相关项目

- [Anthropic SDK](https://github.com/anthropics/anthropic-sdk-typescript)
- [OpenAI SDK](https://github.com/openai/openai-node)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Puppeteer](https://pptr.dev/)

### 术语表

| 术语 | 说明 |
|------|------|
| **Extension Host** | VSCode 扩展运行的 Node.js 环境 |
